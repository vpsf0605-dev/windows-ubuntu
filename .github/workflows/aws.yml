name: ðŸŒ ZUNRDP

on:
  workflow_dispatch:
    inputs:
      machine_name:
        description: 'Chá»n mÃ¡y: Windows hoáº·c Ubuntu'
        required: true
        type: choice
        default: 'Windows'
        options:
          - Windows
          - Ubuntu

jobs:
  setup-windows:
    if: ${{ github.event.inputs.machine_name == 'Windows' }}
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: START WINDOWS
        shell: powershell
        run: |
          Write-Host "===== Há»‡ thá»‘ng ZUNRDP Windows ====="

      - name: CREATE WINDOWS USER
        shell: powershell
        run: |
          $Username="ADMINZUN"
          $Pass="ZunRDP@123456"
          $SecurePass=ConvertTo-SecureString $Pass -AsPlainText -Force
          if (Get-LocalUser -Name $Username -ErrorAction SilentlyContinue) { Remove-LocalUser -Name $Username }
          New-LocalUser -Name $Username -Password $SecurePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $Username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $Username

      - name: INSTALL & CONNECT TAILSCALE
        shell: powershell
        env:
          TOKEN_1: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          $token = $env:TOKEN_1
          $msi="$env:TEMP\tailscale.msi"
          Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i", $msi, "/quiet", "/norestart" -Wait
          Start-Sleep -Seconds 10
          $tsExe="$env:ProgramFiles\Tailscale\Tailscale.exe"
          & $tsExe up --authkey=$token --hostname=ZUNRDP --accept-routes --reset > $null 2>&1
          $ip = & $tsExe ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

      - name: SEND INFO TO TELEGRAM
        shell: powershell
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TAILSCALE_IP: ${{ env.TAILSCALE_IP }}
        run: |
          $MachineID="ZUN-" + -join ((65..90) + (48..57) | Get-Random -Count 6 | % {[char]$_})
          $msg = "MachineID: $MachineID`nIP: $env:TAILSCALE_IP`nUser: ADMINZUN`nPass: ZunRDP@123456"
          $url="https://api.telegram.org/bot$env:TELEGRAM_BOT_TOKEN/sendMessage"
          Invoke-RestMethod -Uri $url -Method Post -Body @{chat_id=$env:TELEGRAM_CHAT_ID; text=$msg} -ErrorAction SilentlyContinue

      - name: LISTEN TELEGRAM COMMANDS
        shell: powershell
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          $MachineID="ZUN-" + -join ((65..90) + (48..57) | Get-Random -Count 6 | % {[char]$_})
          while ($true) {
              $updates = Invoke-RestMethod "https://api.telegram.org/bot$env:TELEGRAM_BOT_TOKEN/getUpdates" -Method Get
              foreach ($u in $updates.result) {
                  if ($u.message.text -like "/kill_$MachineID") {
                      Stop-Computer -Force
                  } elseif ($u.message.text -eq "/list") {
                      $msg="MachineID: $MachineID`nIP: $env:TAILSCALE_IP`nUser: ADMINZUN`nPass: ZunRDP@123456"
                      $url="https://api.telegram.org/bot$env:TELEGRAM_BOT_TOKEN/sendMessage"
                      Invoke-RestMethod -Uri $url -Method Post -Body @{chat_id=$env:TELEGRAM_CHAT_ID; text=$msg} -ErrorAction SilentlyContinue
                  }
              }
              Start-Sleep -Seconds 10
          }
