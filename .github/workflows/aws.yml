name: ZUNRDP

on:
  workflow_dispatch:

jobs:
  setup-windows:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: START WINDOWS
        shell: powershell
        run: |
          Write-Host "ZUNRDP START WINDOWS"

      - name: CREATE USER
        shell: powershell
        run: |
          $u="ADMINZUN"
          $p="ZunRDP@123456"
          $sp=ConvertTo-SecureString $p -AsPlainText -Force
          if (Get-LocalUser -Name $u -ErrorAction SilentlyContinue) {
            Remove-LocalUser -Name $u
          }
          New-LocalUser -Name $u -Password $sp -AccountNeverExpires
          Add-LocalGroupMember -Group Administrators -Member $u
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u

      - name: INSTALL TAILSCALE
        shell: powershell
        env:
          TSKEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          $id="ZUN-"+(-join((48..57)+(65..70)|Get-Random -Count 6|%{[char]$_}))
          echo "MACHINE_ID=$id" >> $env:GITHUB_ENV

          Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi -OutFile ts.msi
          Start-Process msiexec.exe -Wait -ArgumentList "/i ts.msi /quiet /norestart"
          Start-Sleep 10

          $ts="$env:ProgramFiles\Tailscale\Tailscale.exe"
          & $ts up --authkey=$env:TSKEY --hostname=$id --reset > $null 2>&1
          $ip=& $ts ip -4
          echo "TS_IP=$ip" >> $env:GITHUB_ENV

      - name: TELEGRAM CHECK HE THONG
        shell: powershell
        env:
          BOT: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          $msg="CHECK HE THONG`nID: $env:MACHINE_ID"
          Invoke-RestMethod "https://api.telegram.org/bot$env:BOT/sendMessage?chat_id=$env:CHAT&text=$msg" > $null 2>&1

      - name: TELEGRAM CONTROL
        shell: powershell
        env:
          BOT: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          $offset=0
          while ($true) {
            $u=Invoke-RestMethod "https://api.telegram.org/bot$env:BOT/getUpdates?offset=$offset"
            foreach ($r in $u.result) {
              $offset=$r.update_id+1
              $t=$r.message.text
              if ($t -eq "/list") {
                $m="MAY DANG CHAY:`n$env:MACHINE_ID"
                Invoke-RestMethod "https://api.telegram.org/bot$env:BOT/sendMessage?chat_id=$env:CHAT&text=$m" > $null
              }
              if ($t -eq "/kill_$env:MACHINE_ID") {
                shutdown /s /t 5
              }
            }
            Start-Sleep 5
          }
