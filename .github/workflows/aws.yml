name: üåê ZUNRDP

on:
  workflow_dispatch:
    inputs:
      machine_name:
        description: 'Ch·ªçn m√°y: Windows ho·∫∑c Ubuntu'
        required: true
        type: choice
        default: 'Windows'
        options:
          - Windows
          - Ubuntu

jobs:
  setup-windows:
    if: ${{ github.event.inputs.machine_name == 'Windows' }}
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: KH·ªûI ƒê·ªòNG WINDOWS
        shell: powershell
        run: |
          Write-Host "===== H·ªá th·ªëng ZUNRDP ƒëang chu·∫©n b·ªã tr√™n Windows =====" -ForegroundColor Cyan

      - name: T·∫†O USER WINDOWS
        shell: powershell
        run: |
          $Username="ADMINZUN"
          $Pass="ZunRDP@123456"
          $SecurePass=ConvertTo-SecureString $Pass -AsPlainText -Force
          if (Get-LocalUser -Name $Username -ErrorAction SilentlyContinue) { Remove-LocalUser -Name $Username }
          New-LocalUser -Name $Username -Password $SecurePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $Username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $Username

      - name: C√ÄI V√Ä K·∫æT N·ªêI TAILSCALE WINDOWS
        shell: powershell
        env:
          TOKEN_1: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          $token = $env:TOKEN_1
          if (-not $token) { Write-Host "Ch∆∞a c√≥ token"; exit 1 }

          $msi="$env:TEMP\tailscale.msi"
          Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i", $msi, "/quiet", "/norestart" -Wait
          Start-Sleep -Seconds 10

          $tsExe="$env:ProgramFiles\Tailscale\Tailscale.exe"
          if (-Not (Test-Path $tsExe)) { Write-Host "Kh√¥ng t√¨m th·∫•y Tailscale.exe"; exit 1 }

          & $tsExe up --authkey=$token --hostname=ZUNRDP --accept-routes --reset > $null 2>&1
          $ip = & $tsExe ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

      - name: B·∫¢O M·∫¨T H·ªÜ TH·ªêNG (G·ª≠i Telegram)
        shell: powershell
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TAILSCALE_IP: ${{ env.TAILSCALE_IP }}
        run: |
          $MachineID="ZUN-" + -join ((65..90) + (48..57) | Get-Random -Count 6 | % {[char]$_})
          $IP=$env:TAILSCALE_IP
          $User="ADMINZUN"
          $Pass="ZunRDP@123456"
          $Repo="https://github.com/YOUR_REPO"
          $msg = "‚úÖ M√°y $MachineID ƒëang ch·∫°y`nIP: $IP`nUser: $User`nPass: $Pass`nRepo: $Repo"
          $url="https://api.telegram.org/bot$env:TELEGRAM_BOT_TOKEN/sendMessage"
          Invoke-RestMethod -Uri $url -Method Post -Body @{chat_id=$env:TELEGRAM_CHAT_ID; text=$msg} -ErrorAction SilentlyContinue

      - name: TREO M√ÅY WINDOWS (ƒë·ªçc l·ªánh Telegram)
        shell: powershell
        run: |
          while($true){ Start-Sleep -Seconds 60 }

      - name: THO√ÅT TAILSCALE WINDOWS
        if: always()
        shell: powershell
        run: |
          $tsExe="$env:ProgramFiles\Tailscale\Tailscale.exe"
          if (Test-Path $tsExe) { & $tsExe logout }

  setup-ubuntu:
    if: ${{ github.event.inputs.machine_name == 'Ubuntu' }}
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: KH·ªûI ƒê·ªòNG UBUNTU
        shell: bash
        run: |
          echo "===== H·ªá th·ªëng ZUNRDP ƒëang chu·∫©n b·ªã tr√™n Ubuntu ====="

      - name: T·∫†O USER UBUNTU
        shell: bash
        run: |
          sudo useradd -m -s /bin/bash adminzun || true
          echo "adminzun:ZunRDP@123456" | sudo chpasswd
          sudo usermod -aG sudo adminzun

      - name: C√ÄI XRDP (RDP SERVER) UBUNTU
        shell: bash
        run: |
          sudo apt-get update -y
          sudo apt-get install -y xrdp
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          sudo ufw allow 3389/tcp

      - name: C√ÄI V√Ä K·∫æT N·ªêI TAILSCALE UBUNTU
        shell: bash
        env:
          TOKEN_1: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          TOKEN=$TOKEN_1
          if [ -z "$TOKEN" ]; then echo "Ch∆∞a c√≥ token"; exit 1; fi
          sudo apt-get install -y curl gnupg lsb-release apt-transport-https
          DISTRO=$(lsb_release -cs)
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/$DISTRO.gpg | sudo gpg --dearmor -o /usr/share/keyrings/tailscale-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu $DISTRO main" | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update -y
          sudo apt-get install -y tailscale
          sudo tailscale up --authkey=$TOKEN --hostname=ZUNRDP --accept-routes --reset > /dev/null 2>&1
          IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$IP" >> $GITHUB_ENV

      - name: B·∫¢O M·∫¨T H·ªÜ TH·ªêNG (G·ª≠i Telegram)
        shell: bash
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MACHINE_ID="UBU-$(cat /dev/urandom | tr -dc 'A-Z0-9' | head -c 6)"
          MSG="‚úÖ M√°y $MACHINE_ID ƒëang ch·∫°y\nIP: $TAILSCALE_IP\nUser: adminzun\nPass: ZunRDP@123456\nRepo: https://github.com/YOUR_REPO"
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" -d chat_id=$TELEGRAM_CHAT_ID -d text="$MSG"

      - name: TREO M√ÅY UBUNTU (ƒë·ªçc l·ªánh Telegram)
        shell: bash
        run: |
          while true; do sleep 60; done

      - name: THO√ÅT TAILSCALE UBUNTU
        if: always()
        shell: bash
        run: |
          sudo tailscale logout
