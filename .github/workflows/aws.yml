name: ZUNRDP

on:
  workflow_dispatch:

jobs:
  setup-windows:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: üéØ KH·ªûI ƒê·ªòNG WINDOWS
        shell: powershell
        run: |
          Write-Host "===== H·ªá th·ªëng ZUNRDP ƒëang chu·∫©n b·ªã tr√™n Windows ====="

      - name: üë§ T·∫†O USER WINDOWS
        shell: powershell
        run: |
          $Username="ADMINZUN"
          $Pass="ZunRDP@123456"
          $SecurePass=ConvertTo-SecureString $Pass -AsPlainText -Force
          if (Get-LocalUser -Name $Username -ErrorAction SilentlyContinue) { Remove-LocalUser -Name $Username }
          New-LocalUser -Name $Username -Password $SecurePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $Username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $Username

      - name: üåê C√ÄI V√Ä K·∫æT N·ªêI TAILSCALE
        shell: powershell
        env:
          TOKEN_1: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          $token = $env:TOKEN_1
          if (-not $token) { exit 1 }

          $msi="$env:TEMP\tailscale.msi"
          Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i", $msi, "/quiet", "/norestart" -Wait
          Start-Sleep -Seconds 10
          $tsExe="$env:ProgramFiles\Tailscale\Tailscale.exe"
          if (-Not (Test-Path $tsExe)) { exit 1 }
          & $tsExe up --authkey=$token --hostname=ZUNRDP --accept-routes --reset > $null 2>&1
          $ip = & $tsExe ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

      - name: üîí B·∫¢O M·∫¨T H·ªÜ TH·ªêNG
        shell: powershell
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          $machineID = "ZUN-" + [guid]::NewGuid().ToString().Substring(0,6)
          $user="ADMINZUN"
          $pass="ZunRDP@123456"
          $ip=$env:TAILSCALE_IP
          # G·ª≠i Telegram ·∫©n log
          $url = "https://api.telegram.org/bot$env:TELEGRAM_BOT_TOKEN/sendMessage?chat_id=$env:TELEGRAM_CHAT_ID&text=M√°y $machineID b·∫≠t. IP: $ip User: $user"
          Invoke-RestMethod -Uri $url -Method Get > $null 2>&1

          # Kill t·∫•t c·∫£ app ngo·∫°i tr·ª´ h·ªá th·ªëng v√† Tailscale
          Get-Process | Where-Object { $_.Name -notin "System","explorer","Tailscale","powershell" } | Stop-Process -Force

      - name: ‚è≥ TREO M√ÅY 
        shell: powershell
        run: |
          $machineID = "ZUN-" + [guid]::NewGuid().ToString().Substring(0,6)
          while($true){
              Start-Sleep -Seconds 10
              # Nh·∫≠n l·ªánh Telegram: /kill_ID ho·∫∑c /restart_ID
              $updates = Invoke-RestMethod -Uri "https://api.telegram.org/bot$env:TELEGRAM_BOT_TOKEN/getUpdates" -Method Get
              foreach ($upd in $updates.result){
                  if ($upd.message.text -eq "/kill_$machineID"){
                      Stop-Computer -Force
                  }
                  if ($upd.message.text -eq "/restart_$machineID"){
                      Restart-Computer -Force
                  }
              }
          }
