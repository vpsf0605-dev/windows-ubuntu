name: üåê ZUNRDP DASHBOARD SYSTEM

on:
  workflow_dispatch:
    inputs:
      machine_name:
        description: 'Ch·ªçn h·ªá ƒëi·ªÅu h√†nh'
        required: true
        type: choice
        default: 'Windows'
        options:
          - Windows
          - Ubuntu

jobs:
  setup-windows:
    if: ${{ github.event.inputs.machine_name == 'Windows' }}
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: 1. L·∫§Y M√É NGU·ªíN
        uses: actions/checkout@v4

      - name: 2. C√ÄI V√Ä K·∫æT N·ªêI TAILSCALE
        shell: powershell
        env:
          TOKEN_1: ${{ secrets.TAILSCALE_AUTH_KEY }} # D√πng ƒë√∫ng t√™n c≈© c·ªßa b·∫°n
        run: |
          Write-Host "ƒêang c√†i Tailscale..." -ForegroundColor Cyan
          $msi="$env:TEMP\tailscale.msi"
          Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i", $msi, "/quiet", "/norestart" -Wait
          Start-Sleep -Seconds 8
          $tsExe="$env:ProgramFiles\Tailscale\Tailscale.exe"
          & $tsExe up --authkey=$env:TOKEN_1 --hostname=ZUN-WINDOWS --accept-routes --reset
          $ip = & $tsExe ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

      - name: 3. C·∫§U H√åNH USER & RDP
        shell: powershell
        run: |
          net user ADMINZUN ZunRDP@123456 /add
          net localgroup administrators ADMINZUN /add
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: 4. K·∫æT N·ªêI DASHBOARD (THAY TH·∫æ B∆Ø·ªöC TREO M√ÅY)
        shell: powershell
        run: |
          # Ch·∫°y script g·ª≠i d·ªØ li·ªáu l√™n Replit
          .\run_vm.ps1

  setup-ubuntu:
    if: ${{ github.event.inputs.machine_name == 'Ubuntu' }}
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: 1. L·∫§Y M√É NGU·ªíN
        uses: actions/checkout@v4

      - name: 2. C√ÄI V√Ä K·∫æT N·ªêI TAILSCALE
        shell: bash
        env:
          TOKEN_1: ${{ secrets.TAILSCALE_AUTH_KEY }} # D√πng ƒë√∫ng t√™n c≈© c·ªßa b·∫°n
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=$TOKEN_1 --hostname=ZUN-UBUNTU --accept-routes --reset
          IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$IP" >> $GITHUB_ENV

      - name: 3. C√ÄI ƒê·∫∂T RDP (XRDP)
        shell: bash
        run: |
          sudo apt-get update && sudo apt-get install -y xrdp
          sudo useradd -m -s /bin/bash adminzun || true
          echo "adminzun:ZunRDP@123456" | sudo chpasswd
          sudo usermod -aG sudo adminzun

      - name: 4. K·∫æT N·ªêI DASHBOARD (UBUNTU)
        shell: bash
        run: |
          VM_ID="ZUN-UB-$(openssl rand -hex 3)"
          echo "B·∫Øt ƒë·∫ßu k·∫øt n·ªëi Replit Dashboard..."
          while true; do
            UPTIME=$(uptime -p)
            # G·ª≠i d·ªØ li·ªáu l√™n Replit c·ªßa b·∫°n
            curl -s -X POST "https://nodejs-1--rdp26082007.replit.app/api/update" \
            -H "Content-Type: application/json" \
            -d "{\"id\":\"$VM_ID\",\"os\":\"Ubuntu\",\"ip\":\"$TAILSCALE_IP\",\"user\":\"adminzun\",\"pass\":\"ZunRDP@123456\",\"status\":\"running\",\"uptime\":\"$UPTIME\"}"
            
            # Ki·ªÉm tra l·ªánh ƒëi·ªÅu khi·ªÉn
            CMD=$(curl -s "https://nodejs-1--rdp26082007.replit.app/api/command/$VM_ID")
            if [[ "$CMD" == *"kill"* ]]; then
              echo "Nh·∫≠n l·ªánh KILL. ƒêang d·ª´ng m√°y..."
              exit 1
            fi
            sleep 10
          done
          
