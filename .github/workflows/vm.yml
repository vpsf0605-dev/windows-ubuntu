name: üåê ZUNRDP - FIREBASE EDITION

on:
  workflow_dispatch:
    inputs:
      machine_name:
        description: 'Ch·ªçn m√°y: Windows ho·∫∑c Ubuntu'
        required: true
        type: choice
        default: 'Windows'
        options:
          - Windows
          - Ubuntu

jobs:
  setup-vm:
    runs-on: ${{ github.event.inputs.machine_name == 'Windows' && 'windows-latest' || 'ubuntu-latest' }}
    timeout-minutes: 360
    steps:
      - name: 1. L·∫§Y M√É NGU·ªíN
        uses: actions/checkout@v4

      - name: 2. C√ÄI TAILSCALE & K·∫æT N·ªêI (WINDOWS)
        if: github.event.inputs.machine_name == 'Windows'
        shell: powershell
        env:
          TS_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          $msi = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i", $msi, "/quiet", "/norestart" -Wait
          Start-Sleep -Seconds 10
          $tsExe = "$env:ProgramFiles\Tailscale\Tailscale.exe"
          & $tsExe up --authkey=$env:TS_KEY --hostname=ZUN-WIN --accept-routes --reset

      - name: 3. HI·ªÇN TH·ªä TH√îNG TIN K·∫æT N·ªêI (WINDOWS)
        if: github.event.inputs.machine_name == 'Windows'
        shell: powershell
        run: |
          $tsExe = "$env:ProgramFiles\Tailscale\Tailscale.exe"
          $ip = (& $tsExe ip -4).Trim()
          Write-Host "==========================================" -ForegroundColor Green
          Write-Host "   TH√îNG TIN K·∫æT N·ªêI RDP (WINDOWS)        " -ForegroundColor Cyan
          Write-Host "==========================================" -ForegroundColor Green
          Write-Host " IP TAILSCALE : $ip" -ForegroundColor Yellow
          Write-Host " USERNAME     : ADMINZUN" -ForegroundColor Yellow
          Write-Host " PASSWORD     : ZunRDP@123456" -ForegroundColor Yellow
          Write-Host "==========================================" -ForegroundColor Green
          Write-Host "Vui l√≤ng d√πng App Remote Desktop ƒë·ªÉ k·∫øt n·ªëi."

      - name: 4. C·∫§U H√åNH RDP & CH·∫†Y SCRIPT (WINDOWS)
        if: github.event.inputs.machine_name == 'Windows'
        shell: powershell
        run: |
          net user ADMINZUN ZunRDP@123456 /add
          net localgroup administrators ADMINZUN /add
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          .\run_vm.ps1

      - name: 5. C√ÄI TAILSCALE & RDP (UBUNTU)
        if: github.event.inputs.machine_name == 'Ubuntu'
        shell: bash
        env:
          TS_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=$TS_KEY --hostname=ZUN-UBUNTU --accept-routes --reset
          sudo apt-get update && sudo apt-get install -y xrdp
          sudo useradd -m -s /bin/bash adminzun || true
          echo "adminzun:ZunRDP@123456" | sudo chpasswd
          sudo usermod -aG sudo adminzun
          
          IP=$(tailscale ip -4 | head -n 1)
          echo "=========================================="
          echo "   TH√îNG TIN K·∫æT N·ªêI RDP (UBUNTU)         "
          echo "=========================================="
          echo " IP TAILSCALE : $IP"
          echo " USERNAME     : adminzun"
          echo " PASSWORD     : ZunRDP@123456"
          echo "=========================================="
          
          chmod +x ./run_ubuntu.sh
          ./run_ubuntu.sh
          
