name: üåê ZUNRDP DASHBOARD SYSTEM

on:
  workflow_dispatch:
    inputs:
      machine_name:
        description: 'Ch·ªçn m√°y'
        required: true
        type: choice
        default: 'Windows'
        options: [Windows, Ubuntu]

jobs:
  setup-vm:
    runs-on: ${{ github.event.inputs.machine_name == 'Windows' && 'windows-latest' || 'ubuntu-latest' }}
    timeout-minutes: 360
    steps:
      - name: L·∫•y code
        uses: actions/checkout@v4

      # --- PH·∫¶N D√ÄNH CHO WINDOWS ---
      - name: C√†i v√† K·∫øt n·ªëi Tailscale (Windows)
        if: github.event.inputs.machine_name == 'Windows'
        shell: powershell
        env:
          TS_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "Dang cai Tailscale cho Windows..."
          $msi = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i", $msi, "/quiet", "/norestart" -Wait
          Start-Sleep -Seconds 5
          $tsExe = "$env:ProgramFiles\Tailscale\Tailscale.exe"
          & $tsExe up --authkey=$env:TS_KEY --hostname=ZUN-WINDOWS --accept-routes --reset
          
      - name: C·∫•u h√¨nh RDP & Ch·∫°y Script (Windows)
        if: github.event.inputs.machine_name == 'Windows'
        shell: powershell
        run: |
          net user ADMINZUN ZunRDP@123456 /add
          net localgroup administrators ADMINZUN /add
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          .\run_vm.ps1

      # --- PH·∫¶N D√ÄNH CHO UBUNTU ---
      - name: C√†i v√† K·∫øt n·ªëi Tailscale (Ubuntu)
        if: github.event.inputs.machine_name == 'Ubuntu'
        shell: bash
        env:
          TS_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=$TS_KEY --hostname=ZUN-UBUNTU --accept-routes --reset

      - name: C·∫•u h√¨nh RDP & Dashboard (Ubuntu)
        if: github.event.inputs.machine_name == 'Ubuntu'
        shell: bash
        run: |
          sudo apt-get update && sudo apt-get install -y xrdp
          sudo useradd -m -s /bin/bash adminzun || true
          echo "adminzun:ZunRDP@123456" | sudo chpasswd
          sudo usermod -aG sudo adminzun
          VM_ID="ZUN-UB-$RANDOM"
          while true; do
            IP=$(tailscale ip -4)
            curl -s -X POST "https://nodejs-1--rdp26082007.replit.app/api/update" -H "Content-Type: application/json" \
            -d "{\"id\":\"$VM_ID\",\"os\":\"Ubuntu\",\"ip\":\"$IP\",\"user\":\"adminzun\",\"pass\":\"ZunRDP@123456\",\"status\":\"running\",\"uptime\":\"$(uptime -p)\"}"
            CMD=$(curl -s "https://nodejs-1--rdp26082007.replit.app/api/command/$VM_ID")
            [[ "$CMD" == *"kill"* ]] && exit 1
            sleep 10
          done

